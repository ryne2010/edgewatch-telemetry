# EdgeWatch Edge Policy (v1)
#
# Purpose
# - Provide a **single source of truth** for edge-device behavior that impacts:
#   - alert timeliness vs battery/data usage
#   - sampling and send cadence
#   - local buffering limits
#   - simple threshold/hysteresis rules used for device-side "state" and burst sending
#
# Notes
# - This policy is served to devices via GET /api/v1/device-policy.
# - Devices should cache the response using ETag + Cache-Control.
# - The server also consumes some threshold values (e.g., water pressure low).

version: v1

# Devices may cache this policy for up to this many seconds.
cache_max_age_s: 3600

reporting:
  # How often the agent reads sensors when the device is healthy (seconds).
  sample_interval_s: 600

  # How often the agent reads sensors while in a **critical** alert state (seconds).
  # (Currently: low water pressure)
  alert_sample_interval_s: 600

  # Force a keepalive even if nothing changes (seconds).
  # This can be set higher to reduce data usage; alert transitions still send immediately.
  heartbeat_interval_s: 600

  # While in a **critical** alert state, periodically send a full snapshot even if metrics are stable.
  alert_report_interval_s: 600

  # Batch / buffer tuning
  max_points_per_batch: 50
  buffer_max_points: 5000
  buffer_max_age_s: 604800 # 7 days

  # Network retry backoff (seconds)
  backoff_initial_s: 5
  backoff_max_s: 300

# Cost hygiene caps (UTC day)
#
# These are device-side safety rails intended to prevent runaway cellular usage.
# When telemetry bytes hit max_bytes_per_day, the agent switches to heartbeat-only mode.
# Media captures are skipped when snapshot/upload caps are reached.
cost_caps:
  max_bytes_per_day: 50000000
  max_snapshots_per_day: 48
  max_media_uploads_per_day: 48

# Power management profile (12V lead-acid defaults for solar + well battery operation).
power_management:
  enabled: true
  mode: dual

  input_warn_min_v: 11.8
  input_warn_max_v: 14.8

  input_critical_min_v: 11.4
  input_critical_max_v: 15.2

  sustainable_input_w: 15.0
  unsustainable_window_s: 900
  battery_trend_window_s: 1800
  battery_drop_warn_v: 0.25

  saver_sample_interval_s: 1200
  saver_heartbeat_interval_s: 1800
  media_disabled_in_saver: true

# Device operation defaults for owner/operator runtime controls.
operation_defaults:
  default_sleep_poll_interval_s: 604800 # 7 days
  disable_requires_manual_restart: true
  admin_remote_shutdown_enabled: true
  shutdown_grace_s_default: 30
  control_command_ttl_s: 15552000 # 180 days

# Metric-level delta thresholds.
# If a metric changes by >= threshold (absolute), it's considered "worth sending".
# Missing metrics are ignored; boolean and string metrics use equality.
delta_thresholds:
  microphone_level_db: 1.0
  power_input_v: 0.1
  power_input_a: 0.1
  power_input_w: 0.5
  water_pressure_psi: 1.0
  oil_pressure_psi: 1.0
  temperature_c: 0.5
  humidity_pct: 2.0
  oil_level_pct: 1.0
  oil_life_pct: 1.0
  drip_oil_level_pct: 1.0
  battery_v: 0.05
  signal_rssi_dbm: 2
  flow_rate_gpm: 1.0

# Simple thresholds used for device-side "state" and to trigger immediate send.
# Hysteresis prevents flapping.
alert_thresholds:
  # If microphone level falls below this threshold, the API emits a MICROPHONE_OFFLINE alert.
  microphone_offline_db: 60.0
  microphone_offline_open_consecutive_samples: 2
  microphone_offline_resolve_consecutive_samples: 1

  water_pressure_low_psi: 30.0
  water_pressure_recover_psi: 32.0

  oil_pressure_low_psi: 25.0
  oil_pressure_recover_psi: 28.0

  oil_level_low_pct: 20.0
  oil_level_recover_pct: 25.0

  drip_oil_level_low_pct: 20.0
  drip_oil_level_recover_pct: 25.0

  # Oil life is runtime-derived and typically reset manually after service.
  oil_life_low_pct: 15.0
  oil_life_recover_pct: 20.0

  battery_low_v: 11.8
  battery_recover_v: 12.0

  signal_low_rssi_dbm: -95
  signal_recover_rssi_dbm: -90
