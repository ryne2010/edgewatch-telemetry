# ---- Core ----
APP_ENV=dev
LOG_LEVEL=INFO

# Logging format:
# - text (developer-friendly)
# - json (Cloud Logging friendly)
LOG_FORMAT=text

# Optional: OpenTelemetry tracing
# - ENABLE_OTEL=1 turns on best-effort FastAPI instrumentation
# - Configure an exporter with OTEL_EXPORTER_OTLP_ENDPOINT, OTEL_EXPORTER_OTLP_TRACES_ENDPOINT, etc.
# - In dev, if no exporter is configured, EdgeWatch falls back to ConsoleSpanExporter.
ENABLE_OTEL=0

# Postgres (Docker Compose default)
DATABASE_URL=postgresql+psycopg://edgewatch:edgewatch@db:5432/edgewatch

# Automatically run Alembic migrations on API startup.
# When using docker compose, migrations are run by the `migrate` service, so keep this OFF.
# If you run the API directly (no compose), set AUTO_MIGRATE=1.
# In production, prefer running migrations as a separate Cloud Run Job (see docs).
AUTO_MIGRATE=0

# Admin key for provisioning devices (do NOT use this in prod)
ADMIN_API_KEY=dev-admin-key

# Admin route + auth posture
# - ENABLE_ADMIN_ROUTES=0 disables /api/v1/admin entirely (recommended for a public ingest service).
# - ADMIN_AUTH_MODE=key  requires X-Admin-Key (local/dev)
# - ADMIN_AUTH_MODE=none trusts an infrastructure perimeter (Cloud Run IAM/IAP/VPN).
# - IAP_AUTH_ENABLED=1 requires X-Goog-Authenticated-User-Email on admin routes (defense in depth).
ENABLE_ADMIN_ROUTES=1
ADMIN_AUTH_MODE=key
IAP_AUTH_ENABLED=0

# Optional in-app RBAC (viewer/operator/admin).
# Default behavior:
# - dev: disabled
# - stage/prod: enabled
#
# Identity sources:
# - IAP headers in perimeter deployments
# - dev principal headers/env in APP_ENV=dev (for local RBAC testing)
AUTHZ_ENABLED=0
AUTHZ_IAP_DEFAULT_ROLE=viewer
# Comma-separated allowlists (case-insensitive)
# AUTHZ_VIEWER_EMAILS=viewer1@example.com,viewer2@example.com
# AUTHZ_OPERATOR_EMAILS=operator1@example.com
# AUTHZ_ADMIN_EMAILS=admin1@example.com

# Local dev principal mode for RBAC testing
AUTHZ_DEV_PRINCIPAL_ENABLED=1
AUTHZ_DEV_PRINCIPAL_EMAIL=dev-admin@local.edgewatch
AUTHZ_DEV_PRINCIPAL_ROLE=admin

# Optional per-request override headers in local dev:
# - X-EdgeWatch-Dev-Principal-Email
# - X-EdgeWatch-Dev-Principal-Role

# Route surface toggles
# - ENABLE_UI=0 removes the React UI routes (useful for a public ingest-only service)
# - ENABLE_READ_ROUTES=0 removes dashboard read endpoints (/api/v1/devices, /api/v1/alerts, /api/v1/contracts)
# - ENABLE_INGEST_ROUTES=0 removes ingest endpoints (/api/v1/ingest, /api/v1/device-policy, /api/v1/internal/pubsub/push)
ENABLE_UI=1
ENABLE_READ_ROUTES=1
ENABLE_INGEST_ROUTES=1

# Enable/disable in-process scheduler (offline check). In production, disable this
# and trigger the Cloud Run Job entrypoint instead (python -m api.app.jobs.offline_check).
ENABLE_SCHEDULER=1

# Disable OpenAPI/docs in non-dev envs by default (override if you want docs enabled).
# ENABLE_DOCS=1

# PBKDF2 iteration count for hashing device tokens.
# Higher is slower/safer; tune for your fleet.
TOKEN_PBKDF2_ITERATIONS=210000

# Offline monitor runs every N seconds
OFFLINE_CHECK_INTERVAL_S=30

# Edge policy contract (device optimization + thresholds)
EDGE_POLICY_VERSION=v1

# Optional override (quick experimentation). Prefer editing contracts/edge_policy/*.
# DEFAULT_WATER_PRESSURE_LOW_PSI=30.0

# Optional overrides (quick experimentation). Prefer contracts/edge_policy/*.
# DEFAULT_BATTERY_LOW_V=11.8
# DEFAULT_SIGNAL_LOW_RSSI_DBM=-95

# Telemetry data contract
TELEMETRY_CONTRACT_VERSION=v1
# If true (recommended), known metrics must match the declared type.
# Unknown keys are still accepted (additive drift) but recorded in ingestion batches.
TELEMETRY_CONTRACT_ENFORCE_TYPES=1
# Unknown keys: allow|flag (flag records drift events without blocking ingest)
TELEMETRY_CONTRACT_UNKNOWN_KEYS_MODE=allow
# Type mismatches: reject|quarantine
TELEMETRY_CONTRACT_TYPE_MISMATCH_MODE=reject

# Alert routing + delivery adapter (generic/slack/discord/telegram)
ALERT_DEDUPE_WINDOW_S=900
ALERT_THROTTLE_WINDOW_S=3600
ALERT_THROTTLE_MAX_NOTIFICATIONS=20
ALERT_QUIET_HOURS_START=22:00
ALERT_QUIET_HOURS_END=06:00
ALERT_QUIET_HOURS_TZ=UTC
# ALERT_WEBHOOK_URL=
ALERT_WEBHOOK_KIND=generic
ALERT_WEBHOOK_TIMEOUT_S=5

# Optional event-driven ingest mode
INGEST_PIPELINE_MODE=direct
INGEST_PUBSUB_TOPIC=edgewatch-telemetry-raw
# INGEST_PUBSUB_PROJECT_ID=your-project-id
# Optional shared token for /api/v1/internal/pubsub/push
# INGEST_PUBSUB_PUSH_SHARED_TOKEN=replace-me

# Optional analytics export lane
ANALYTICS_EXPORT_ENABLED=0
# ANALYTICS_EXPORT_BUCKET=your-bucket
ANALYTICS_EXPORT_DATASET=edgewatch_analytics
ANALYTICS_EXPORT_TABLE=telemetry_points
ANALYTICS_EXPORT_GCS_PREFIX=telemetry
ANALYTICS_EXPORT_MAX_ROWS=50000

# Media storage lane (camera snapshots/clips)
# local: store bytes on disk (default dev/compose path below)
# gcs: store bytes in GCS bucket (Cloud Run)
MEDIA_STORAGE_BACKEND=local
MEDIA_LOCAL_ROOT=./data/media
# MEDIA_GCS_BUCKET=your-media-bucket
MEDIA_GCS_PREFIX=media
MEDIA_MAX_UPLOAD_BYTES=20000000

# Optional retention / compaction job (recommended)
#
# The retention entrypoint is intended to run as a Cloud Run Job:
#   python -m api.app.jobs.retention
#
# Safety guardrail: nothing is deleted unless RETENTION_ENABLED=1.
RETENTION_ENABLED=0
# RETENTION_DRY_RUN=1
TELEMETRY_RETENTION_DAYS=7
QUARANTINE_RETENTION_DAYS=7
RETENTION_BATCH_SIZE=5000
RETENTION_MAX_BATCHES=50

# Safety limits (defense in depth)
# Cap JSON request bodies for write endpoints (ingest/admin/push).
MAX_REQUEST_BODY_BYTES=1000000
# Cap points per request even if the JSON body is small.
MAX_POINTS_PER_REQUEST=5000

# Basic in-app rate limiting (per device) measured in points/minute.
# In production, prefer perimeter rate limiting (API Gateway/Cloud Armor) and
# keep this as a backstop.
RATE_LIMIT_ENABLED=1
INGEST_RATE_LIMIT_POINTS_PER_MIN=25000

# CORS (set to * for local dev only)
CORS_ALLOW_ORIGINS=*

# If enabled, creates a demo device automatically on startup (dev only)
BOOTSTRAP_DEMO_DEVICE=1
# Number of demo devices to create. If DEMO_DEVICE_ID/NAME/TOKEN end with `001`,
# the remaining devices will be derived by incrementing that 3-digit suffix.
DEMO_FLEET_SIZE=3
DEMO_DEVICE_ID=demo-well-001
DEMO_DEVICE_NAME=Demo Well 001
DEMO_DEVICE_TOKEN=dev-device-token-001
