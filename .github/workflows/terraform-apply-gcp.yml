name: Terraform apply (GCP)

on:
  workflow_dispatch:
    inputs:
      env:
        description: "Environment name (dev/prod/etc). Controls service_name prefix + tfstate prefix."
        required: true
        default: "dev"
      tfvars:
        description: "Optional Terraform var-file path (e.g., infra/gcp/cloud_run_demo/profiles/dev_public_demo.tfvars)"
        required: false
        default: ""

permissions:
  contents: read
  id-token: write

concurrency:
  group: terraform-apply-${{ github.event.inputs.env }}
  cancel-in-progress: false

jobs:
  apply:
    runs-on: ubuntu-latest

    env:
      PROJECT_ID: ${{ vars.PROJECT_ID }}
      REGION: ${{ vars.REGION }}
      # Optional overrides (if unset/empty, the workflow computes safe defaults)
      TF_STATE_BUCKET: ${{ vars.TF_STATE_BUCKET }}
      TF_STATE_PREFIX: ${{ vars.TF_STATE_PREFIX }}
      AR_REPO: ${{ vars.AR_REPO }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WIF_PROVIDER }}
          service_account: ${{ vars.GCP_WIF_SERVICE_ACCOUNT }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.14.5"

      - name: Configure gcloud defaults
        run: |
          gcloud config set project "$PROJECT_ID"
          gcloud config set run/region "$REGION"

      - name: Terraform apply
        env:
          ENV: ${{ github.event.inputs.env }}
          TFVARS: ${{ github.event.inputs.tfvars }}
          TAG: ${{ github.sha }}
        run: |
          set -euo pipefail

          TF_STATE_BUCKET_EFFECTIVE="${TF_STATE_BUCKET:-${PROJECT_ID}-tfstate}"
          TF_STATE_PREFIX_EFFECTIVE="${TF_STATE_PREFIX:-edgewatch/${ENV}}"
          AR_REPO_EFFECTIVE="${AR_REPO:-edgewatch}"

          make apply-gcp \
            TF_STATE_BUCKET="$TF_STATE_BUCKET_EFFECTIVE" \
            TF_STATE_PREFIX="$TF_STATE_PREFIX_EFFECTIVE" \
            AR_REPO="$AR_REPO_EFFECTIVE"
